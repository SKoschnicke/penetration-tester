#!/usr/bin/env ruby
require 'nmap/program'
require 'nmap/xml'
require 'pony'

# all that need to be changed is defined in config.rb (see config.rb.example) for possible values
require './config.rb'

Nmap::Program.scan do |nmap|
  nmap.syn_scan = true
  nmap.service_scan = true
  nmap.skip_discovery = true
  nmap.aggressive_timing = true
  nmap.xml = 'scan.xml'
  nmap.verbose = false

  nmap.ports = (0..65535).to_a
  nmap.targets = ALLOWED_OPEN_PORTS.keys
end

problems = []
Nmap::XML.new('scan.xml') do |xml|
  xml.each_host do |host|
    ports = ALLOWED_OPEN_PORTS[host.hostname.to_s] || []
    host.each_port do |port|
      if port.state == :open && !ports.include?(port.number)
        problems << "ERROR! Port should not be open on #{host.hostname}: #{port.number}/#{port.protocol} (#{port.service})"
      end
    end
  end
end

unless problems.empty?
  message = "Hello,\n"+
    "there where problems checking the servers:\n\n"+
    problems.join("\n")+"\n"+
    "\n"+
    "You should check if everything is okay."

  Pony.mail({
              :to => ADMIN_MAIL_ADDRESS,
              :via => :smtp,
              :via_options => MAIL_OPTIONS,
              :from => FROM_MAIL_ADDRESS,
              :subject => "Error while checking servers!",
              :body => message
  })
end
